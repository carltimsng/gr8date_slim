{% load static %}
{% now 'U' as cachebust %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ profile.display_name }} • GR8DATE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Always fetch the latest CSS -->
  <link href="{% static 'css/base.css' %}?v={{ cachebust }}" rel="stylesheet">

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    /* Page-specific styles ONLY (no logo/global rules here) */
    :root { --text:#111; --muted:#666; --border:#e6e6e6; --bg:#fafafa; --card:#fff; }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1100px;margin:20px auto;padding:0 14px}

    /* Header / icon bar (layout only) */
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .left,.right{display:flex;gap:10px;align-items:center}
    .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:42px;height:42px;border-radius:12px;border:1px solid var(--border);background:#fff;color:#111;text-decoration:none;cursor:pointer;transition:.15s transform,.15s box-shadow}
    .icon-btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .material-icons{font-size:22px;line-height:1}
    .icon-rotate-90{transform:rotate(90deg)}

    /* Header profile summary */
    .head{display:flex;gap:18px;align-items:center;margin:16px 0}
    .avatar{width:96px;height:96px;border-radius:50%;object-fit:cover;border:2px solid #eee;background:#f6f6f6;flex:0 0 auto}
    .meta{color:var(--muted)}
    h1{margin:0 0 4px}

    /* Action buttons row */
    .actions{display:flex;gap:10px;margin:10px 0 6px}
    .actions .icon-btn{width:auto;min-width:42px;padding:0 12px;gap:8px}
    .actions .material-icons{font-size:20px}

    /* Photos grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:12px}
    .tile{position:relative;border-radius:16px;overflow:hidden;background:#f8f8f8;border:1px solid #e6e6ef;cursor:pointer}
    .tile img{width:100%;height:100%;object-fit:cover;display:block;aspect-ratio:4/5}
    .tile.private{cursor:default}
    .tile.private img{filter:blur(12px);transform:scale(1.02)}
    .private .veil{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;background:rgba(0,0,0,.45);text-align:center;padding:10px}

    /* Lightbox */
    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:9999}
    .lightbox.open{display:flex}
    .lightbox img{max-width:92vw;max-height:84vh;border-radius:8px;display:block}
    .lb-controls{position:absolute;top:50%;left:0;right:0;display:flex;justify-content:space-between;transform:translateY(-50%);padding:0 20px;gap:10px}
    .lb-btn{background:rgba(255,255,255,.9);border:none;border-radius:8px;padding:10px 14px;font-weight:700;cursor:pointer}
    .lb-close{position:absolute;top:18px;right:18px;background:#fff;border:none;border-radius:999px;font-weight:800;padding:8px 12px;cursor:pointer}
    .caption{position:absolute;bottom:16px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.55);color:#fff;padding:8px 12px;border-radius:8px;max-width:80vw}

    /* Modal (layout only; base.css has generic modal styling too) */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.55);z-index:9999}
    .modal.open{display:flex}
    .sheet{width:min(720px,92vw);background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden}
    .sheet header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .sheet main{padding:14px}
    .row{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    label{font-size:.9rem;color:#5b6270;display:block;margin-bottom:6px}
    input,select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .actions-row{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .btn.primary{background:#111;color:#fff;border-color:#111}

    /* Tiny addition: lock background scroll when lightbox is open */
    html.gd-lock { overflow: hidden; }
  </style>
</head>
<body>
  <main class="wrap">
    <!-- FULL ICON BAR -->
    <header>
      <div class="left">
        {% include "pages/partials/logo_noclick.html" %}
      </div>
      <div class="right">
        <a class="icon-btn" href="{% url 'pages:dashboard' %}?page=1" title="Dashboard start" aria-label="Dashboard start">
          <span class="material-icons icon-rotate-90">u_turn_left</span>
        </a>
        <button class="icon-btn" id="openSearch" type="button" title="Search" aria-label="Search">
          <span class="material-icons">search</span>
        </button>
        <a class="icon-btn" href="{% url 'pages:messages' %}" title="Messages" aria-label="Messages">
          <span class="material-icons">mail</span>
        </a>
        <button class="icon-btn" type="button" title="Matches (coming soon)" aria-label="Matches">
          <span class="material-icons">people</span>
        </button>
        <a class="icon-btn" href="{% url 'pages:hot_dates' %}" title="Hot Dates" aria-label="Hot Dates">
          <span class="material-icons">whatshot</span>
        </a>
        <a class="icon-btn" href="{% url 'pages:my_profile_edit' %}" title="Edit Profile" aria-label="Edit Profile">
          <span class="material-icons">person</span>
        </a>

        <!-- CHANGED: logout opens modal (no direct navigation) -->
        <button class="icon-btn" type="button" data-logout-open title="Log Out" aria-label="Log out">
          <span class="material-icons">logout</span>
        </button>
      </div>
    </header>

    <!-- HEADER SUMMARY -->
    <section class="head">
      {% if profile.primary_image %}
        <img class="avatar" src="{{ profile.primary_image.url }}" alt="{{ profile.display_name }}">
      {% else %}
        {% with fp=profile.public_images.first %}
          {% if fp and fp.image %}
            <img class="avatar" src="{{ fp.image.url }}" alt="{{ profile.display_name }}">
          {% else %}
            <div class="avatar" role="img" aria-label="No profile image"></div>
          {% endif %}
        {% endwith %}
      {% endif %}
      <div>
        <h1>{{ profile.display_name }}{% if profile.age %}, {{ profile.age }}{% endif %}</h1>
        <div class="meta">{{ profile.location }}</div>
      </div>
    </section>

    <!-- ACTION BUTTONS -->
    <div class="actions">
      <form action="{% url 'pages:toggle_favorite' profile.pk %}" method="post" style="display:inline">
        {% csrf_token %}
        <button class="icon-btn" type="submit" title="Favourite">
          <span class="material-icons" {% if is_favorited %}style="color:#e0245e"{% endif %}>favorite</span>
        </button>
      </form>

      <a class="icon-btn" href="{% url 'pages:messages' %}" title="Message">
        <span class="material-icons">mail</span>
      </a>

      <form action="{% url 'pages:block_profile' profile.pk %}" method="post" style="display:inline">
        {% csrf_token %}
        <button class="icon-btn" type="submit" title="Block">
          <span class="material-icons" {% if is_blocked %}style="color:#555"{% endif %}>block</span>
        </button>
      </form>
    </div>

    <!-- PHOTOS FIRST -->
    {% if photos_public or photos_additional %}
      <section>
        <h2>Photos</h2>
        <div class="grid" id="public-grid">
          {% for ph in photos_public %}
            {% if ph.image and ph.image.name %}
              <div class="tile" data-index="{{ forloop.counter0 }}" data-src="{{ ph.image.url }}">
                <img src="{{ ph.image.url }}" alt="{{ profile.display_name }}">
              </div>
            {% endif %}
          {% endfor %}
          {% with base=photos_public|length %}
            {% for ph in photos_additional %}
              {% if ph.image and ph.image.name %}
                <div class="tile" data-index="{{ base|add:forloop.counter0 }}" data-src="{{ ph.image.url }}">
                  <img src="{{ ph.image.url }}" alt="{{ profile.display_name }}">
                </div>
              {% endif %}
            {% endfor %}
          {% endwith %}
        </div>
      </section>
    {% endif %}

    {% if photos_private %}
      <section>
        <h2>Private Photos</h2>
        <div class="grid">
          {% for ph in photos_private %}
            {% if ph.image and ph.image.name %}
              <div class="tile private" aria-label="Private photo">
                <img src="{{ ph.image.url }}" alt="Private photo">
                <div class="veil">
                  <form action="{% url 'pages:request_private_access' profile.pk %}" method="post">
                    {% csrf_token %}
                    <div>Private • Request access to view</div>
                    <button class="btn btn-primary" type="submit">Request Access</button>
                  </form>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
        <p class="hint">Private photos remain blurred until the owner approves your request.</p>
      </section>
    {% endif %}

    <!-- ABOUT LAST -->
    <section>
      <h2>About</h2>
      <p>{{ profile.bio|linebreaks }}</p>
    </section>

    <!-- LIGHTBOX -->
    <div class="lightbox" id="lightbox" aria-hidden="true">
      <button class="lb-close" id="lbClose" aria-label="Close">✕</button>
      <div class="lb-controls">
        <button class="lb-btn" id="lbPrev" aria-label="Previous">◀</button>
        <button class="lb-btn" id="lbNext" aria-label="Next">▶</button>
      </div>
      <img id="lbImg" alt="">
      <div class="caption" id="lbCaption"></div>
    </div>
  </main>

  <!-- Search Modal (copied from dashboard) -->
  <div class="modal" id="searchModal" aria-hidden="true">
    <div class="sheet">
      <header>
        <strong>Search Profiles</strong>
        <button class="icon-btn" id="closeSearch" type="button" title="Close">
          <span class="material-icons">close</span>
        </button>
      </header>
      <main>
        <form method="get" action="{% url 'pages:dashboard' %}">
          <div class="row">
            <div>
              <label>Keyword</label>
              <input name="q" value="{{ q|default_if_none:'' }}">
            </div>
            <div>
              <label>Location</label>
              <input name="location" value="{{ search_params.location|default_if_none:'' }}">
            </div>
          </div>
          <div class="row" style="margin-top:12px">
            <div>
              <label>Age Min</label>
              <input type="number" name="age_min" value="{{ search_params.age_min }}">
            </div>
            <div>
              <label>Age Max</label>
              <input type="number" name="age_max" value="{{ search_params.age_max }}">
            </div>
          </div>
          {% if user.is_superuser %}
          <div class="row" style="margin-top:12px">
            <div>
              <label>Gender (superuser only)</label>
              <select name="gender">
                <option value="">Any</option>
                <option value="Female" {% if search_params.gender == 'Female' %}selected{% endif %}>Female</option>
                <option value="Male" {% if search_params.gender == 'Male' %}selected{% endif %}>Male</option>
                <option value="Other" {% if search_params.gender == 'Other' %}selected{% endif %}>Other</option>
              </select>
            </div>
          </div>
          {% endif %}
          <div class="actions-row">
            <a class="btn" href="{% url 'pages:dashboard' %}">Reset</a>
            <button class="btn primary" type="submit">Search</button>
          </div>
        </form>
      </main>
    </div>
  </div>

  <!-- ADD: Logout Modal (reusable partial) -->
  {% include "pages/partials/logout_modal.html" %}

  <script>
    // Lightbox (safe enhancements: caption, scroll-lock, keyboard)
    (function(){
      const tiles = Array.from(document.querySelectorAll('#public-grid .tile'));
      const lb = document.getElementById('lightbox');
      const lbImg = document.getElementById('lbImg');
      const lbCap = document.getElementById('lbCaption');
      const lbPrev = document.getElementById('lbPrev');
      const lbNext = document.getElementById('lbNext');
      const lbClose = document.getElementById('lbClose');

      if (!tiles.length || !lb || !lbImg) return;

      let idx = 0;

      function getSrcFromTile(t){
        return t?.dataset?.src || t?.querySelector('img')?.getAttribute('src') || '';
      }
      function getCaptionFromTile(t){
        return t?.querySelector('img')?.getAttribute('alt') || '';
      }

      function openLightbox(i){
        if (!tiles.length) return;
        idx = ((i % tiles.length) + tiles.length) % tiles.length;
        const t = tiles[idx];
        const src = getSrcFromTile(t);
        if (!src) return;

        lbImg.src = src;
        lbCap.textContent = getCaptionFromTile(t);
        lb.classList.add('open');
        lb.setAttribute('aria-hidden','false');

        // lock background scroll
        document.documentElement.classList.add('gd-lock');

        // focus for a11y
        lbClose.focus();
      }

      function closeLightbox(){
        lb.classList.remove('open');
        lb.setAttribute('aria-hidden','true');
        lbImg.src = '';
        document.documentElement.classList.remove('gd-lock');
      }

      function next(){ openLightbox(idx + 1); }
      function prev(){ openLightbox(idx - 1); }

      // Click handlers on tiles + keyboard activation
      tiles.forEach((t)=>{
        const i = parseInt(t.dataset.index ?? '0', 10);
        t.addEventListener('click', ()=>openLightbox(i));
        t.setAttribute('tabindex','0');
        t.addEventListener('keydown', (e)=>{
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            openLightbox(i);
          }
        });
      });

      lbNext.addEventListener('click', next);
      lbPrev.addEventListener('click', prev);
      lbClose.addEventListener('click', closeLightbox);

      // Click outside image to close
      lb.addEventListener('click', (e)=>{ if(e.target === lb) closeLightbox(); });

      // Keyboard controls when open
      document.addEventListener('keydown', (e)=>{
        if (!lb.classList.contains('open')) return;
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowRight') next();
        if (e.key === 'ArrowLeft') prev();
      });
    })();

    // Search Modal
    const modal = document.getElementById('searchModal');
    const openBtn = document.getElementById('openSearch');
    const closeBtn = document.getElementById('closeSearch');
    if (openBtn) openBtn.addEventListener('click', ()=>{ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); });
    if (closeBtn) closeBtn.addEventListener('click', ()=>{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); });
    modal?.addEventListener('click', (e)=>{ if(e.target===modal){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }});
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.classList.contains('open')){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }});
  </script>
</body>
</html>

